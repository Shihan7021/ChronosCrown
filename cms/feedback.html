<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - TimeMachine CMS</title>
    <link rel="stylesheet" href="../css/cms.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="cms-container">
        <!-- Sidebar -->
        <aside class="cms-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-clock"></i> TimeMachine CMS</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="products.html"><i class="fas fa-swatchbook"></i> Products</a></li>
                    <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                    <li><a href="content.html"><i class="fas fa-edit"></i> Content</a></li>
                    <li><a href="feedback.html" class="active"><i class="fas fa-comments"></i> Feedback</a></li>
                    <li><a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    <li><a href="users.html"><i class="fas fa-users"></i> Users</a></li>
                    <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="cms-main">
            <header class="cms-header">
                <h1>Customer Feedback</h1>
                <div class="header-actions">
                    <div class="filter-controls">
                        <select id="status-filter" class="form-control">
                            <option value="all">All Feedback</option>
                            <option value="pending">Pending Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <select id="rating-filter" class="form-control">
                            <option value="all">All Ratings</option>
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Feedback Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon rating">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-feedback">0</h3>
                            <p>Total Reviews</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pending-feedback">0</h3>
                            <p>Pending Review</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon approved">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="approved-feedback">0</h3>
                            <p>Approved</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon average">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="average-rating">0.0</h3>
                            <p>Average Rating</p>
                        </div>
                    </div>
                </div>

                <!-- Feedback List -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Customer Reviews</h2>
                        <div class="table-controls">
                            <input type="text" id="feedback-search" placeholder="Search reviews..." class="form-control">
                        </div>
                    </div>

                    <div class="feedback-list" id="feedback-list">
                        <!-- Feedback items loaded via JavaScript -->
                    </div>

                    <div class="table-footer">
                        <div class="pagination">
                            <button class="btn btn-sm" id="prev-page">Previous</button>
                            <span id="page-info">Page 1 of 1</span>
                            <button class="btn btn-sm" id="next-page">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Check authentication
        if (localStorage.getItem('cmsAuthenticated') !== 'true') {
            window.location.href = 'login.html';
        }

        let testimonials = JSON.parse(localStorage.getItem('testimonials')) || [];
        let currentPage = 1;
        const itemsPerPage = 8;

        // Sample data if empty
        if (testimonials.length === 0) {
            testimonials = [
                {
                    id: 1,
                    name: 'John Smith',
                    email: 'john@example.com',
                    rating: 5,
                    message: 'Excellent quality and fast shipping! The watch exceeded my expectations.',
                    status: 'approved',
                    date: '2023-11-15',
                    productId: 1
                },
                {
                    id: 2,
                    name: 'Sarah Johnson',
                    email: 'sarah@example.com',
                    rating: 4,
                    message: 'Beautiful watch, but the strap is a bit tight. Otherwise, great product!',
                    status: 'approved',
                    date: '2023-11-14',
                    productId: 2
                },
                {
                    id: 3,
                    name: 'Mike Wilson',
                    email: 'mike@example.com',
                    rating: 5,
                    message: 'Perfect gift for my wife. She loves it! Great customer service too.',
                    status: 'pending',
                    date: '2023-11-13',
                    productId: 4
                },
                {
                    id: 4,
                    name: 'Emily Davis',
                    email: 'emily@example.com',
                    rating: 3,
                    message: 'The watch looks nice but stopped working after 2 weeks. Support was helpful though.',
                    status: 'approved',
                    date: '2023-11-12',
                    productId: 3
                }
            ];
            localStorage.setItem('testimonials', JSON.stringify(testimonials));
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadFeedback();
            updateFeedbackStats();
            setupEventListeners();
        });

        function loadFeedback() {
            const container = document.getElementById('feedback-list');
            const filteredFeedback = filterFeedback();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedFeedback = filteredFeedback.slice(startIndex, startIndex + itemsPerPage);

            if (paginatedFeedback.length === 0) {
                container.innerHTML = `
                    <div class="no-feedback">
                        <i class="fas fa-comments"></i>
                        <h3>No feedback found</h3>
                        <p>There are no reviews matching your current filters.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = paginatedFeedback.map(feedback => `
                <div class="feedback-item ${feedback.status}">
                    <div class="feedback-header">
                        <div class="reviewer-info">
                            <div class="reviewer-name">${feedback.name}</div>
                            <div class="reviewer-email">${feedback.email}</div>
                            <div class="review-date">${new Date(feedback.date).toLocaleDateString()}</div>
                        </div>
                        <div class="review-rating">
                            ${'★'.repeat(feedback.rating)}${'☆'.repeat(5 - feedback.rating)}
                            <span class="rating-number">${feedback.rating}.0</span>
                        </div>
                    </div>
                    
                    <div class="feedback-content">
                        <p>${feedback.message}</p>
                    </div>

                    <div class="feedback-actions">
                        <span class="status-badge ${feedback.status}">${feedback.status}</span>
                        <div class="action-buttons">
                            ${feedback.status === 'pending' ? `
                                <button class="btn btn-sm btn-success approve-feedback" data-id="${feedback.id}">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-sm btn-danger reject-feedback" data-id="${feedback.id}">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline delete-feedback" data-id="${feedback.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            updatePagination(filteredFeedback.length);
        }

        function filterFeedback() {
            const statusFilter = document.getElementById('status-filter').value;
            const ratingFilter = document.getElementById('rating-filter').value;
            const searchTerm = document.getElementById('feedback-search').value.toLowerCase();

            return testimonials.filter(feedback => {
                // Status filter
                if (statusFilter !== 'all' && feedback.status !== statusFilter) return false;
                
                // Rating filter
                if (ratingFilter !== 'all' && feedback.rating != ratingFilter) return false;
                
                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        feedback.name,
                        feedback.email,
                        feedback.message
                    ].join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                return true;
            });
        }

        function updateFeedbackStats() {
            const total = testimonials.length;
            const pending = testimonials.filter(f => f.status === 'pending').length;
            const approved = testimonials.filter(f => f.status === 'approved').length;
            const averageRating = testimonials.length > 0 ? 
                testimonials.reduce((sum, f) => sum + f.rating, 0) / testimonials.length : 0;

            document.getElementById('total-feedback').textContent = total;
            document.getElementById('pending-feedback').textContent = pending;
            document.getElementById('approved-feedback').textContent = approved;
            document.getElementById('average-rating').textContent = averageRating.toFixed(1);
        }

        function setupEventListeners() {
            // Filters
            document.getElementById('status-filter').addEventListener('change', () => {
                currentPage = 1;
                loadFeedback();
                updateFeedbackStats();
            });
            document.getElementById('rating-filter').addEventListener('change', () => {
                currentPage = 1;
                loadFeedback();
            });
            document.getElementById('feedback-search').addEventListener('input', () => {
                currentPage = 1;
                loadFeedback();
            });

            // Pagination
            document.getElementById('prev-page').addEventListener('click', () => changePage(-1));
            document.getElementById('next-page').addEventListener('click', () => changePage(1));

            // Delegated events for dynamic content
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('approve-feedback')) {
                    updateFeedbackStatus(e.target.closest('button').dataset.id, 'approved');
                }
                if (e.target.classList.contains('reject-feedback')) {
                    updateFeedbackStatus(e.target.closest('button').dataset.id, 'rejected');
                }
                if (e.target.classList.contains('delete-feedback')) {
                    deleteFeedback(e.target.closest('button').dataset.id);
                }
            });
        }

        function updateFeedbackStatus(feedbackId, newStatus) {
            const feedbackIndex = testimonials.findIndex(f => f.id == feedbackId);
            if (feedbackIndex !== -1) {
                testimonials[feedbackIndex].status = newStatus;
                testimonials[feedbackIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('testimonials', JSON.stringify(testimonials));
                loadFeedback();
                updateFeedbackStats();
                showNotification(`Feedback ${newStatus} successfully`, 'success');
            }
        }

        function deleteFeedback(feedbackId) {
            if (confirm('Are you sure you want to delete this feedback? This action cannot be undone.')) {
                testimonials = testimonials.filter(f => f.id != feedbackId);
                localStorage.setItem('testimonials', JSON.stringify(testimonials));
                loadFeedback();
                updateFeedbackStats();
                showNotification('Feedback deleted successfully', 'success');
            }
        }

        function changePage(direction) {
            const filteredFeedback = filterFeedback();
            const totalPages = Math.ceil(filteredFeedback.length / itemsPerPage);
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            loadFeedback();
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout functionality
        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('cmsAuthenticated');
            localStorage.removeItem('isAdmin');
            window.location.href = 'login.html';
        });
    </script>

    <style>
        .feedback-list {
            padding: 0;
        }
        .feedback-item {
            padding: 2rem;
            border-bottom: 1px solid #eee;
        }
        .feedback-item:last-child {
            border-bottom: none;
        }
        .feedback-item.pending {
            background: #fffbf5;
            border-left: 4px solid #f39c12;
        }
        .feedback-item.approved {
            background: #f8fff8;
            border-left: 4px solid #27ae60;
        }
        .feedback-item.rejected {
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .reviewer-info {
            flex: 1;
        }
        .reviewer-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        .reviewer-email {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .review-date {
            color: #95a5a6;
            font-size: 0.8rem;
        }
        .review-rating {
            text-align: right;
        }
        .rating-number {
            display: block;
            font-weight: 600;
            color: #f39c12;
            margin-top: 0.25rem;
        }
        .feedback-content {
            margin-bottom: 1.5rem;
            line-height: 1.6;
            color: #2c3e50;
        }
        .feedback-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .no-feedback {
            text-align: center;
            padding: 4rem 2rem;
            color: #7f8c8d;
        }
        .no-feedback i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }
        .no-feedback h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
    </style>
</body>
</html>