<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - TimeMachine CMS</title>
    <link rel="stylesheet" href="../css/cms.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="cms-container">
        <!-- Sidebar -->
        <aside class="cms-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-clock"></i> TimeMachine CMS</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="products.html"><i class="fas fa-swatchbook"></i> Products</a></li>
                    <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                    <li><a href="content.html"><i class="fas fa-edit"></i> Content</a></li>
                    <li><a href="feedback.html"><i class="fas fa-comments"></i> Feedback</a></li>
                    <li><a href="analytics.html" class="active"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    <li><a href="users.html"><i class="fas fa-users"></i> Users</a></li>
                    <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="cms-main">
            <header class="cms-header">
                <h1>Analytics & Reports</h1>
                <div class="header-actions">
                    <select id="time-range" class="form-control">
                        <option value="7d">Last 7 Days</option>
                        <option value="30d" selected>Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                        <option value="1y">Last Year</option>
                    </select>
                    <button class="btn btn-outline" id="export-report">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                </div>
            </header>

            <div class="content-area">
                <!-- Key Metrics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-revenue">$0</h3>
                            <p>Total Revenue</p>
                            <span class="stat-change" id="revenue-change">+0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orders">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-orders">0</h3>
                            <p>Total Orders</p>
                            <span class="stat-change" id="orders-change">+0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon customers">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-customers">0</h3>
                            <p>New Customers</p>
                            <span class="stat-change" id="customers-change">+0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon conversion">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="conversion-rate">0%</h3>
                            <p>Conversion Rate</p>
                            <span class="stat-change" id="conversion-change">+0%</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="analytics-grid">
                    <div class="section-card">
                        <div class="section-header">
                            <h2>Revenue Overview</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header">
                            <h2>Sales by Category</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Additional Charts -->
                <div class="analytics-grid">
                    <div class="section-card">
                        <div class="section-header">
                            <h2>Order Trends</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="orders-chart"></canvas>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header">
                            <h2>Customer Acquisition</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="customers-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Top Performing Products</h2>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                    <th>Avg. Rating</th>
                                </tr>
                            </thead>
                            <tbody id="top-products">
                                <!-- Top products loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Traffic Sources -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Traffic Sources</h2>
                    </div>
                    <div class="traffic-sources">
                        <div class="traffic-item">
                            <div class="traffic-source">Direct</div>
                            <div class="traffic-bar">
                                <div class="traffic-fill" style="width: 45%"></div>
                            </div>
                            <div class="traffic-percentage">45%</div>
                        </div>
                        <div class="traffic-item">
                            <div class="traffic-source">Organic Search</div>
                            <div class="traffic-bar">
                                <div class="traffic-fill" style="width: 30%"></div>
                            </div>
                            <div class="traffic-percentage">30%</div>
                        </div>
                        <div class="traffic-item">
                            <div class="traffic-source">Social Media</div>
                            <div class="traffic-bar">
                                <div class="traffic-fill" style="width: 15%"></div>
                            </div>
                            <div class="traffic-percentage">15%</div>
                        </div>
                        <div class="traffic-item">
                            <div class="traffic-source">Email</div>
                            <div class="traffic-bar">
                                <div class="traffic-fill" style="width: 10%"></div>
                            </div>
                            <div class="traffic-percentage">10%</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Check authentication
        if (localStorage.getItem('cmsAuthenticated') !== 'true') {
            window.location.href = 'login.html';
        }

        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let products = JSON.parse(localStorage.getItem('cms-products')) || [];
        let testimonials = JSON.parse(localStorage.getItem('testimonials')) || [];

        // Generate sample data if empty
        if (orders.length === 0) {
            orders = generateSampleOrders();
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateMetrics();
            loadTopProducts();
            setupEventListeners();
        });

        function generateSampleOrders() {
            const sampleOrders = [];
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 90); // Last 90 days
            
            for (let i = 0; i < 50; i++) {
                const orderDate = new Date(startDate);
                orderDate.setDate(orderDate.getDate() + Math.floor(Math.random() * 90));
                
                const items = [];
                const itemCount = Math.floor(Math.random() * 3) + 1;
                let total = 0;
                
                for (let j = 0; j < itemCount; j++) {
                    const product = products[Math.floor(Math.random() * products.length)];
                    const quantity = Math.floor(Math.random() * 2) + 1;
                    const itemTotal = product.price * quantity;
                    total += itemTotal;
                    
                    items.push({
                        productId: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: quantity
                    });
                }
                
                sampleOrders.push({
                    id: 'TM-' + (1000 + i),
                    date: orderDate.toISOString(),
                    customerName: ['John Smith', 'Sarah Johnson', 'Mike Wilson', 'Emily Davis'][Math.floor(Math.random() * 4)],
                    customerEmail: ['john@example.com', 'sarah@example.com', 'mike@example.com', 'emily@example.com'][Math.floor(Math.random() * 4)],
                    items: items,
                    total: total,
                    status: ['pending', 'processing', 'shipped', 'delivered'][Math.floor(Math.random() * 4)]
                });
            }
            
            return sampleOrders;
        }

        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                    datasets: [{
                        label: 'Revenue',
                        data: [12000, 19000, 15000, 25000, 22000, 30000, 28000],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Category Chart
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Him', 'Her'],
                    datasets: [{
                        data: [65, 35],
                        backgroundColor: ['#3498db', '#e74c3c'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Orders Chart
            const ordersCtx = document.getElementById('orders-chart').getContext('2d');
            new Chart(ordersCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                    datasets: [{
                        label: 'Orders',
                        data: [45, 60, 55, 80, 75, 95, 85],
                        backgroundColor: '#27ae60',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Customers Chart
            const customersCtx = document.getElementById('customers-chart').getContext('2d');
            new Chart(customersCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                    datasets: [{
                        label: 'New Customers',
                        data: [120, 150, 140, 180, 170, 200, 190],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateMetrics() {
            const currentPeriodOrders = orders.filter(order => {
                const orderDate = new Date(order.date);
                const daysAgo = new Date();
                daysAgo.setDate(daysAgo.getDate() - 30);
                return orderDate >= daysAgo;
            });

            const previousPeriodOrders = orders.filter(order => {
                const orderDate = new Date(order.date);
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 60);
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - 30);
                return orderDate >= startDate && orderDate < endDate;
            });

            // Calculate metrics
            const currentRevenue = currentPeriodOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            const previousRevenue = previousPeriodOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            const revenueChange = previousRevenue > 0 ? ((currentRevenue - previousRevenue) / previousRevenue * 100) : 0;

            const currentOrders = currentPeriodOrders.length;
            const previousOrders = previousPeriodOrders.length;
            const ordersChange = previousOrders > 0 ? ((currentOrders - previousOrders) / previousOrders * 100) : 0;

            // Update DOM
            document.getElementById('total-revenue').textContent = '$' + currentRevenue.toLocaleString();
            document.getElementById('total-orders').textContent = currentOrders;
            document.getElementById('total-customers').textContent = new Set(currentPeriodOrders.map(o => o.customerEmail)).size;
            document.getElementById('conversion-rate').textContent = '2.5%'; // Simplified conversion rate

            // Update changes
            document.getElementById('revenue-change').textContent = 
                (revenueChange >= 0 ? '+' : '') + revenueChange.toFixed(1) + '%';
            document.getElementById('revenue-change').className = `stat-change ${revenueChange >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('orders-change').textContent = 
                (ordersChange >= 0 ? '+' : '') + ordersChange.toFixed(1) + '%';
            document.getElementById('orders-change').className = `stat-change ${ordersChange >= 0 ? 'positive' : 'negative'}`;
        }

        function loadTopProducts() {
            const productSales = {};
            
            orders.forEach(order => {
                order.items?.forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = {
                            quantity: 0,
                            revenue: 0,
                            ratings: []
                        };
                    }
                    productSales[item.productId].quantity += item.quantity;
                    productSales[item.productId].revenue += item.price * item.quantity;
                });
            });

            // Add ratings
            testimonials.forEach(testimonial => {
                if (productSales[testimonial.productId]) {
                    productSales[testimonial.productId].ratings.push(testimonial.rating);
                }
            });

            const topProducts = Object.entries(productSales)
                .map(([productId, data]) => {
                    const product = products.find(p => p.id == productId);
                    if (!product) return null;
                    
                    const avgRating = data.ratings.length > 0 ? 
                        data.ratings.reduce((a, b) => a + b) / data.ratings.length : 0;
                    
                    return {
                        product: product,
                        quantity: data.quantity,
                        revenue: data.revenue,
                        rating: avgRating
                    };
                })
                .filter(Boolean)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            const tbody = document.getElementById('top-products');
            tbody.innerHTML = topProducts.map(item => `
                <tr>
                    <td>
                        <div class="product-info">
                            <img src="${item.product.image}" alt="${item.product.name}" class="product-thumb">
                            <span>${item.product.name}</span>
                        </div>
                    </td>
                    <td><span class="category-badge ${item.product.category}">${item.product.category}</span></td>
                    <td>${item.quantity}</td>
                    <td>$${item.revenue.toFixed(2)}</td>
                    <td>
                        <div class="rating-display">
                            ${'★'.repeat(Math.round(item.rating))}${'☆'.repeat(5 - Math.round(item.rating))}
                            <span>(${item.rating.toFixed(1)})</span>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function setupEventListeners() {
            document.getElementById('time-range').addEventListener('change', function() {
                // In a real implementation, this would reload data based on the selected range
                showNotification(`Showing data for ${this.options[this.selectedIndex].text}`, 'info');
            });

            document.getElementById('export-report').addEventListener('click', function() {
                // Simulate report export
                showNotification('Report exported successfully!', 'success');
            });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Logout functionality
        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('cmsAuthenticated');
            localStorage.removeItem('isAdmin');
            window.location.href = 'login.html';
        });
    </script>

    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .chart-container {
            height: 300px;
            position: relative;
        }
        .traffic-sources {
            padding: 1rem 2rem;
        }
        .traffic-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .traffic-source {
            width: 120px;
            font-weight: 600;
        }
        .traffic-bar {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 1rem;
        }
        .traffic-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 10px;
        }
        .traffic-percentage {
            width: 50px;
            text-align: right;
            font-weight: 600;
        }
        .product-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .rating-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .rating-display span {
            color: #666;
            font-size: 0.9rem;
        }
        @media (max-width: 1024px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>